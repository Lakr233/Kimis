#!/bin/bash

PROJECT_ROOT="$(pwd)"
SWIFT_FILES_DIR="$PROJECT_ROOT/Kimis"
ANCHOR_FILE="$PROJECT_ROOT/Kimis/Resources/L10nAnchors.swift"
XCSTRINGS_FILE="$PROJECT_ROOT/Kimis/Resources/Localizable.xcstrings"

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}â„¹ï¸ $1${NC}" >&2
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}" >&2
}

log_warning() {
    echo -e "${YELLOW}âš ï¸ $1${NC}" >&2
}

log_error() {
    echo -e "${RED}âŒ $1${NC}" >&2
}

extract_localization_keys() {
    log_info "æ‰«æ Swift æ–‡ä»¶ä¸­çš„æœ¬åœ°åŒ–é”®..."

    # ä¸´æ—¶æ–‡ä»¶å­˜å‚¨æå–çš„é”®
    local temp_file=$(mktemp)

    # æŸ¥æ‰¾æ‰€æœ‰ Swift æ–‡ä»¶ï¼ˆæŽ’é™¤é”šç‚¹æ–‡ä»¶æœ¬èº«ï¼‰
    find "$SWIFT_FILES_DIR" -name "*.swift" ! -name "L10nAnchors.swift" -type f | while read -r swift_file; do
        # æå– L10n.text è°ƒç”¨ä¸­çš„å­—ç¬¦ä¸²
        grep -o 'L10n\.text(\s*"[^"]*"' "$swift_file" 2>/dev/null |
            sed 's/L10n\.text(\s*"\([^"]*\)"/\1/' |
            sed 's/\\n/\n/g' |
            sed 's/\\"/"/g' |
            grep -v '^L10n\.text' >>"$temp_file"

        # æå–å¸¦å‚æ•°çš„ L10n.text è°ƒç”¨
        grep -o 'L10n\.text(\s*"[^"]*"\s*,' "$swift_file" 2>/dev/null |
            sed 's/L10n\.text(\s*"\([^"]*\)"\s*,/\1/' |
            sed 's/\\n/\n/g' |
            sed 's/\\"/"/g' |
            grep -v '^L10n\.text' >>"$temp_file"
    done

    # è¿‡æ»¤æŽ‰æ—¥å¿—ä¿¡æ¯ç­‰éžæœ¬åœ°åŒ–å­—ç¬¦ä¸²
    grep -v '^\[0;' "$temp_file" | grep -v '^â„¹ï¸' >"${temp_file}.filtered"
    mv "${temp_file}.filtered" "$temp_file"

    # åŽ»é‡å¹¶æŽ’åº
    sort -u "$temp_file"

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$temp_file"
}

read_existing_xcstrings_keys() {
    if [[ -f "$XCSTRINGS_FILE" ]]; then
        # ä½¿ç”¨ jq æå– .xcstrings æ–‡ä»¶ä¸­çš„æ‰€æœ‰é”®
        if command -v jq >/dev/null 2>&1; then
            jq -r '.strings | keys[]' "$XCSTRINGS_FILE" 2>/dev/null | sort
        else
            log_warning "æœªæ‰¾åˆ° jq å‘½ä»¤ï¼Œæ— æ³•è¯»å– .xcstrings æ–‡ä»¶"
            echo ""
        fi
    else
        echo ""
    fi
}
generate_anchor_file() {
    local keys_file="$1"

    log_info "ç”Ÿæˆé”šç‚¹æ–‡ä»¶..."

    # ç”Ÿæˆæ–‡ä»¶å¤´
    cat >"$ANCHOR_FILE" <<'EOF'
//
//  L10nAnchors.swift
//  Kimis
//
//  Created by Star on 2025/10/8.
//  DO NOT EDIT MANUALLY - This file is automatically generated
//

import Foundation

// DO NOT call these at runtime. They are only for Xcode string extraction.
enum _L10nAnchors {
    static func _register() {
EOF

    # æ·»åŠ æ‰€æœ‰é”®
    while IFS= read -r key; do
        if [[ -n "$key" ]]; then
            # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
            escaped_key=$(echo "$key" | sed 's/"/\\"/g' | sed 's/\n/\\n/g')
            echo "        _ = NSLocalizedString(\"$escaped_key\", comment: \"\")" >>"$ANCHOR_FILE"
        fi
    done <"$keys_file"

    # ç”Ÿæˆæ–‡ä»¶å°¾
    cat >>"$ANCHOR_FILE" <<'EOF'
    }
}
EOF
}

main() {
    log_info "å¼€å§‹æ›´æ–°æœ¬åœ°åŒ–é”®..."

    # æå–ä»£ç ä¸­çš„é”®
    local code_keys_file=$(mktemp)
    extract_localization_keys >"$code_keys_file"
    local code_keys_count=$(wc -l <"$code_keys_file" | tr -d ' ')

    # è¯»å–çŽ°æœ‰çš„ .xcstrings æ–‡ä»¶ä¸­çš„é”®
    local existing_keys_file=$(mktemp)
    read_existing_xcstrings_keys >"$existing_keys_file"
    local existing_keys_count=$(wc -l <"$existing_keys_file" | tr -d ' ')

    log_success "åœ¨ä»£ç ä¸­æ‰¾åˆ° $code_keys_count ä¸ªæœ¬åœ°åŒ–é”®"
    log_success "åœ¨ .xcstrings æ–‡ä»¶ä¸­æ‰¾åˆ° $existing_keys_count ä¸ªçŽ°æœ‰é”®"

    # ç”Ÿæˆé”šç‚¹æ–‡ä»¶
    generate_anchor_file "$code_keys_file"

    # è®¡ç®—æ–°æ·»åŠ çš„é”®
    local new_keys_file=$(mktemp)
    comm -23 "$code_keys_file" "$existing_keys_file" >"$new_keys_file"
    local new_keys_count=$(wc -l <"$new_keys_file" | tr -d ' ')

    log_success "å·²æ›´æ–° $ANCHOR_FILE"
    echo ""
    echo "ðŸ“Š ç»Ÿè®¡:"
    echo "   - ä»£ç ä¸­çš„é”®: $code_keys_count"
    echo "   - çŽ°æœ‰ .xcstrings é”®: $existing_keys_count"
    echo "   - æ–°æ·»åŠ çš„é”®: $new_keys_count"

    # æ˜¾ç¤ºæ–°æ·»åŠ çš„é”®
    if [[ $new_keys_count -gt 0 ]]; then
        echo ""
        echo "ðŸ†• æ–°å‘çŽ°çš„é”®:"
        while IFS= read -r key; do
            echo "   - $key"
        done <"$new_keys_file"
    fi

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$code_keys_file" "$existing_keys_file" "$new_keys_file"
}

# æ£€æŸ¥æ˜¯å¦åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
if [[ ! -d "$SWIFT_FILES_DIR" ]]; then
    log_error "è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# è¿è¡Œä¸»å‡½æ•°
main
